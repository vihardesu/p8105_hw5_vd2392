---
title: "p8105_hw5_vd2392.Rmd"
output: github_document
---

## Setup 

##### General
```{r general_setup}
knitr::opts_chunk$set(
  echo = TRUE,
  include = TRUE,
  message = FALSE,
  warning = FALSE
)
```

##### Visualizations
```{r visualiztion_setup}
knitr::opts_chunk$set(
  fig.width = 6,
  fig.asp = .6,
  out.width = "90%"
)


```

##### Installations
```{r installations}
library(tidyverse)
library(ggridges)
library(patchwork)
library(readxl)
```

## Problem 1

Dataset: This dataset contains 52,000 criminal homicides over the past decade in 50 of the largest American cities. Among the variables of interest include location of the killing, whether an arrest was made and, in most cases, basic demographic information of each victim.

```{r}
homicide_df = 
  read_csv("data/homicide-data.csv") %>% 
  mutate(
    city_state = str_c(city, state, sep = "_"),
    resolved = case_when(
      disposition == "Closed without arrest" ~ "unsolved",
      disposition == "Open/No arrest"        ~ "unsolved",
      disposition == "Closed by arrest"      ~ "solved",
    )
  ) %>% 
  select(city_state, resolved) %>% 
  filter(city_state != "Tulsa_AL")
```

```{r}
aggregate_df = 
  homicide_df %>% 
  group_by(city_state) %>% 
  summarize(
    hom_total = n(),
    hom_unsolved = sum(resolved == "unsolved")
  )


```

#### Table Preview
```{r}
knitr::kable(head(aggregate_df), "simple", caption = "Source:")
```

Can I do a prop test for a single city?

```{r}
prop_test = prop.test(
  aggregate_df %>% filter(city_state == "Baltimore_MD") %>% pull(hom_unsolved), 
  aggregate_df %>% filter(city_state == "Baltimore_MD") %>% pull(hom_total)) %>% 
  broom::tidy()
```

#### Table Preview
```{r}
knitr::kable(prop_test, "simple", caption = "Source:")
```

Try to iterate ........

```{r}
results_df = 
  aggregate_df %>% 
  mutate(
    prop_tests = map2(.x = hom_unsolved, .y = hom_total, ~prop.test(x = .x, n = .y)),
    tidy_tests = map(.x = prop_tests, ~broom::tidy(.x))
  ) %>% 
  select(-prop_tests) %>% 
  unnest(tidy_tests) %>% 
  select(city_state, estimate, conf.low, conf.high)
```


#### Table Preview
```{r}
knitr::kable(results_df, "simple", caption = "Source:")
```


```{r}
results_df %>% 
  mutate(city_state = fct_reorder(city_state, estimate)) %>% 
  ggplot(aes(x = city_state, y = estimate)) +
  geom_point() + 
  geom_errorbar(aes(ymin = conf.low, ymax = conf.high)) + 
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust = 1))
```

## Problem 2



```{r}

data_path = "data/p2_data/"

df = 
  tibble(
    file = list.files(data_path),
  )

knitr::kable(df, "simple", caption = "Source:")

```


#### Table Preview
```{r}


extract = function(path) {
 data = read_csv(path) %>% 
  janitor::clean_names()
 data
}


new = df %>% 
  mutate(
    path = str_c(data_path, file),
    data = as.vector(map_dfr(path, extract))
  )

new$data



```

### Part 3

```{r}

final = new %>% {
  bind_cols(select(., file:path), bind_rows(!!!.$data))
}

final = final  %>% 
  mutate(
    subject_id = case_when(
      substr(file, 0, 3) == "con" ~ paste("Control", substr(file, 5, 6), sep = "_"),
      substr(file, 0, 3) == "exp" ~ paste("Experimental", substr(file, 5, 6), sep = "_")
    ),
    treatment_arm = case_when(
      substr(file, 0, 3) == "con" ~ "Control",
      substr(file, 0, 3) == "exp" ~ "Experimental"
    )
  ) %>% 
  select(
    treatment_arm, subject_id, week_1:week_8
  ) %>% 
  pivot_longer(
    week_1:week_8,
    names_to = "week",
    values_to = "result",
    names_prefix = "week_"
  ) %>% 
  mutate(
    week = as.numeric(week)
  )

final
#, color = subject_id
ggplot(data = final, aes(x = week, y = result, color = treatment_arm)) + 
  geom_point(data = final) + 
  geom_line(data = final, aes(x = week, y = result, color = treatment_arm))
```
### Problem 3


```{r}
n = 30
sigma = 5
alpha = 0.05
mu = 0

simulation = function(n = n, mu = mu, sigma = sigma, alpha = alpha) {
  data = tibble(
    x = rnorm(n, mean = mu, sd = sigma)
  )
  data %>% 
    summarize(
      mu_hat = mean(x),
      p.value = t.test(x, mu = mu, conf.level = 1 - alpha) %>% 
        broom::tidy() %>% 
        select(p.value)
    ) %>% 
    unnest(p.value) %>% 
    mutate(
      reject = as.logical(p.value < alpha)
    )
}

```


```{r}

output = vector("list", length = 6)

trials = 500

for (i in 1:6) {
  output[[i]] = rerun(trials, simulation(n, i, sigma, alpha)) %>% 
  bind_rows
}

sim_results = 
  tibble(true_mu = c(1,2,3,4,5,6)) %>% 
  mutate(
    estimate_dfs = map(output, bind_rows)) %>% 
  unnest(estimate_dfs)
sim_results
```

## Plots
## http://www.sthda.com/english/wiki/ggplot2-barplots-quick-start-guide-r-software-and-data-visualization

true mu by sum(pvalue > .05) / sum(trials at true mu)
(0 - 6) vs. (~5% ...)

```{r}


sim_results %>% 
  group_by(true_mu) %>% 
  summarize(
    proportion = sum(reject) / trials
  ) %>% 
  ggplot(aes(x = true_mu, y = proportion, fill=true_mu)) +
    geom_bar(stat="identity")+
    geom_text(aes(label=proportion), vjust=1.6, color="white", size=3.5)

```


## Plot 2
true  mu by avg(mu_hat over 5000 trials)

```{r}
sim_results %>% 
  mutate(
    true_mu = str_c("n = ", true_mu),
    true_mu = fct_inorder(true_mu)) %>% 
  ggplot(aes(x = true_mu, y = mu_hat, fill = true_mu)) + 
    geom_violin()

```
true mu by avg(mu_har for subset of 5000 trials where rejected)


```{r}
sim_results %>% 
  filter(
    p.value < 0.05
  ) %>% 
  mutate(
    true_mu = str_c("n = ", true_mu),
    true_mu = fct_inorder(true_mu)) %>% 
  ggplot(aes(x = true_mu, y = mu_hat, fill = true_mu)) + 
    geom_violin()

```




